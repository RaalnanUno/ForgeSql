{"version":3,"sources":["../../main/index.ts","../../main/db/sqlserver.ts","../../main/db/queries.ts"],"sourcesContent":["import { app, BrowserWindow, ipcMain } from \"electron\";\r\nimport path from \"path\";\r\nimport {\r\n  DbListDatabasesResponse,\r\n  DbListTablesResponse,\r\n  DbListViewsResponse,\r\n  DbOpenResponse,\r\n  DbQueryResponse,\r\n  SqlServerConnectionProfile,\r\n} from \"../shared/types\";\r\nimport { openDb, closeDb, queryText } from \"./db/sqlserver\";\r\nimport { listDatabasesSql, listTablesSql, listViewsSql } from \"./db/queries\";\r\n\r\nlet win: BrowserWindow | null = null;\r\n\r\nfunction formatError(e: any): string {\r\n  if (!e) return \"Unknown error (empty).\";\r\n  if (typeof e === \"string\") return e;\r\n\r\n  // common shapes\r\n  if (e.message) return String(e.message);\r\n  if (e.originalError?.message) return String(e.originalError.message);\r\n\r\n  // mssql/tedious/msnodesqlv8 sometimes use these\r\n  if (e.code || e.number || e.state) {\r\n    const bits = [\r\n      e.code ? `code=${e.code}` : null,\r\n      e.number ? `number=${e.number}` : null,\r\n      e.state ? `state=${e.state}` : null,\r\n      e.class ? `class=${e.class}` : null,\r\n      e.serverName ? `server=${e.serverName}` : null,\r\n    ].filter(Boolean);\r\n    const details = bits.length ? ` (${bits.join(\", \")})` : \"\";\r\n    return `Database error${details}`;\r\n  }\r\n\r\n  // last resort: dump all enumerable + non-enumerable props\r\n  try {\r\n    return JSON.stringify(e, Object.getOwnPropertyNames(e), 2);\r\n  } catch {\r\n    return String(e);\r\n  }\r\n}\r\n\r\nasync function createWindow() {\r\n  win = new BrowserWindow({\r\n    width: 1200,\r\n    height: 800,\r\n    webPreferences: {\r\n      preload: path.join(__dirname, \"../preload/index.js\"),\r\n      contextIsolation: true,\r\n      nodeIntegration: false,\r\n    },\r\n  });\r\n\r\n  // Vite dev server or built file:\r\n  const devUrl = process.env.VITE_DEV_SERVER_URL;\r\n  if (devUrl) await win.loadURL(devUrl);\r\n  else\r\n    await win.loadFile(\r\n      path.join(__dirname, \"../../../reactui/dist/index.html\"),\r\n    );\r\n}\r\n\r\napp.whenReady().then(createWindow);\r\n\r\napp.on(\"window-all-closed\", async () => {\r\n  await closeDb();\r\n  if (process.platform !== \"darwin\") app.quit();\r\n});\r\n\r\nipcMain.handle(\r\n  \"db:open\",\r\n  async (\r\n    _evt,\r\n    args: { profile: SqlServerConnectionProfile },\r\n  ): Promise<DbOpenResponse> => {\r\n    try {\r\n      await openDb(args.profile);\r\n      return { ok: true };\r\n    } catch (e: any) {\r\n      console.error(\"db:open failed raw:\", e);\r\n      console.error(\"db:open failed formatted:\", formatError(e));\r\n      return { ok: false, error: formatError(e) };\r\n    }\r\n  },\r\n);\r\n\r\nipcMain.handle(\"db:close\", async (): Promise<DbOpenResponse> => {\r\n  try {\r\n    await closeDb();\r\n    return { ok: true };\r\n  } catch (e: any) {\r\n    console.error(\"db:open failed raw:\", e);\r\n    console.error(\"db:open failed formatted:\", formatError(e));\r\n    return { ok: false, error: formatError(e) };\r\n  }\r\n});\r\n\r\nipcMain.handle(\r\n  \"db:listDatabases\",\r\n  async (): Promise<DbListDatabasesResponse> => {\r\n    try {\r\n      const r = await queryText(listDatabasesSql);\r\n      const databases = r.rows.map((x) => String(x[0]));\r\n      return { ok: true, databases };\r\n    } catch (e: any) {\r\n      console.error(\"db:open failed raw:\", e);\r\n      console.error(\"db:open failed formatted:\", formatError(e));\r\n      return { ok: false, error: formatError(e) };\r\n    }\r\n  },\r\n);\r\n\r\nipcMain.handle(\"db:listTables\", async (): Promise<DbListTablesResponse> => {\r\n  try {\r\n    const r = await queryText(listTablesSql);\r\n    const tables = r.rows.map((x) => String(x[0]));\r\n    return { ok: true, tables };\r\n  } catch (e: any) {\r\n    console.error(\"db:open failed raw:\", e);\r\n    console.error(\"db:open failed formatted:\", formatError(e));\r\n    return { ok: false, error: formatError(e) };\r\n  }\r\n});\r\n\r\nipcMain.handle(\"db:listViews\", async (): Promise<DbListViewsResponse> => {\r\n  try {\r\n    const r = await queryText(listViewsSql);\r\n    const views = r.rows.map((x) => String(x[0]));\r\n    return { ok: true, views };\r\n  } catch (e: any) {\r\n    console.error(\"db:open failed raw:\", e);\r\n    console.error(\"db:open failed formatted:\", formatError(e));\r\n    return { ok: false, error: formatError(e) };\r\n  }\r\n});\r\n\r\nipcMain.handle(\r\n  \"db:query\",\r\n  async (_evt, args: { sql: string }): Promise<DbQueryResponse> => {\r\n    try {\r\n      const r = await queryText(args.sql);\r\n      return {\r\n        ok: true,\r\n        result: { columns: r.columns, rows: r.rows },\r\n        rowCount: r.rowCount,\r\n      };\r\n    } catch (e: any) {\r\n      console.error(\"db:open failed raw:\", e);\r\n      console.error(\"db:open failed formatted:\", formatError(e));\r\n      return { ok: false, error: formatError(e) };\r\n    }\r\n  },\r\n);\r\n","import sql from \"mssql/msnodesqlv8\";\r\n\r\nimport { SqlServerConnectionProfile } from \"../../shared/types\";\r\n\r\nlet pool: sql.ConnectionPool | null = null;\r\n\r\ntype NormalizedServer = { host: string; instanceName?: string; port?: number };\r\ntype NodeSqlV8Config = {\r\n  connectionString: string;\r\n  options?: {\r\n    // keep these optional; msnodesqlv8 uses connectionString primarily\r\n    trustServerCertificate?: boolean;\r\n    encrypt?: boolean;\r\n  };\r\n};\r\n\r\nfunction normalizeServer(raw: string): NormalizedServer {\r\n  const s0 = (raw ?? \"\").trim();\r\n  const s = s0.replace(/^tcp:/i, \"\");\r\n\r\n  const comma = s.lastIndexOf(\",\");\r\n  if (comma > 0) {\r\n    const host = s.substring(0, comma).trim();\r\n    const portStr = s.substring(comma + 1).trim();\r\n    const port = Number(portStr);\r\n    if (Number.isFinite(port) && port > 0) return { host, port };\r\n  }\r\n\r\n  if (s.toLowerCase().startsWith(\"(localdb)\\\\\")) {\r\n    return { host: s }; // might still be flaky; default instance is easier\r\n  }\r\n\r\n  if (s.startsWith(\".\\\\\")) {\r\n    const instanceName = s.substring(2);\r\n    return { host: \"localhost\", instanceName: instanceName || undefined };\r\n  }\r\n\r\n  const idx = s.indexOf(\"\\\\\");\r\n  if (idx > 0) {\r\n    const host = s.substring(0, idx);\r\n    const instanceName = s.substring(idx + 1);\r\n    return { host, instanceName: instanceName || undefined };\r\n  }\r\n  \r\n  if (s === \".\") return { host: \"(local)\" };\r\n  return { host: s || \"localhost\" };\r\n}\r\n\r\nfunction buildConfig(profile: SqlServerConnectionProfile): NodeSqlV8Config {\r\n  const encrypt = profile.encrypt ?? false;\r\n  const trustServerCertificate = profile.trustServerCertificate ?? true;\r\n\r\n  const normalized = normalizeServer(profile.server);\r\n\r\n  // Use \".\" by default (matches your sqlcmd success)\r\n  const host =\r\n    normalized.host === \".\" || normalized.host.toLowerCase() === \"localhost\" || normalized.host === \"(local)\"\r\n      ? \".\"\r\n      : normalized.host;\r\n\r\n  const db = profile.database ?? \"master\";\r\n\r\n  let serverPart = host;\r\n  if (normalized.instanceName) serverPart = `${host}\\\\${normalized.instanceName}`;\r\n  if (normalized.port) serverPart = `${host},${normalized.port}`;\r\n\r\n  const parts: string[] = [];\r\n  parts.push(`Server=${serverPart}`);\r\n  parts.push(`Database=${db}`);\r\n\r\n  if (profile.auth.kind === \"sql\") {\r\n    parts.push(`Uid=${profile.auth.user}`);\r\n    parts.push(`Pwd=${profile.auth.password}`);\r\n  } else {\r\n    // both work; SSMS/sqlcmd style is Trusted_Connection\r\n    parts.push(`Trusted_Connection=Yes`);\r\n  }\r\n\r\n  if (trustServerCertificate) parts.push(`TrustServerCertificate=Yes`);\r\n  if (encrypt) parts.push(`Encrypt=Yes`);\r\n\r\n  return {\r\n    connectionString: parts.join(\";\") + \";\"\r\n  };\r\n}\r\n\r\nexport async function openDb(profile: SqlServerConnectionProfile) {\r\n  await closeDb();\r\n  const cfg = buildConfig(profile);\r\n  pool = await new sql.ConnectionPool(cfg as any).connect();\r\n}\r\n\r\nexport async function closeDb() {\r\n  if (pool) {\r\n    try {\r\n      await pool.close();\r\n    } finally {\r\n      pool = null;\r\n    }\r\n  }\r\n}\r\n\r\nexport async function queryText(sqlText: string) {\r\n  if (!pool) throw new Error(\"No open connection.\");\r\n  const resp = await pool.request().query(sqlText);\r\n\r\n  const recordset = resp.recordset ?? [];\r\n  const columns = recordset.length ? Object.keys(recordset[0]) : [];\r\n  const rows = recordset.map((r: any) => columns.map((c) => r[c]));\r\n\r\n  return { columns, rows, rowCount: resp.rowsAffected?.[0] ?? 0 };\r\n}\r\n","export const listDatabasesSql = `\r\nSELECT name\r\nFROM sys.databases\r\nWHERE database_id > 4\r\nORDER BY name;\r\n`;\r\n\r\nexport const listTablesSql = `\r\nSELECT s.name + '.' + t.name AS [name]\r\nFROM sys.tables t\r\nJOIN sys.schemas s ON t.schema_id = s.schema_id\r\nORDER BY s.name, t.name;\r\n`;\r\n\r\nexport const listViewsSql = `\r\nSELECT s.name + '.' + v.name AS [name]\r\nFROM sys.views v\r\nJOIN sys.schemas s ON v.schema_id = s.schema_id\r\nORDER BY s.name, v.name;\r\n`;\r\n\r\nexport function selectTopSql(fullName: string, top = 100) {\r\n  return `SELECT TOP (${top}) * FROM ${fullName};`;\r\n}"],"mappings":"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","names":["sql","path"]}